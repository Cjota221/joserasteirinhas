<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vendas e Estoque</title>
    <style>
        /* CSS Reset and Basic Styles */
        :root {
            --dark-blue: #1A237E;
            --medium-blue: #303F9F;
            --light-blue: #C5CAE9;
            --dark-gray: #212121;
            --medium-gray: #757575;
            --light-gray: #F5F5F5;
            --white: #FFFFFF;
            --danger: #D32F2F;
            --success: #388E3C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        /* Container and Header */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        header {
            background-color: var(--dark-blue);
            color: var(--white);
            padding: 1.5rem;
            text-align: center;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        /* Profile Section */
        .profile-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-top: 2rem;
        }

        .photo-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--light-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-blue);
            flex-shrink: 0;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        
        .photo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-blue);
            border: none;
            padding-bottom: 0;
            cursor: pointer;
            width: 100%;
        }

        .user-name-input {
            font-family: inherit;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-blue);
            border: none;
            border-bottom: 2px solid var(--dark-blue);
            outline: none;
            background: transparent;
            width: 100%;
        }


        /* Section Title */
        h2 {
            font-size: 1.5rem;
            color: var(--dark-blue);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-blue);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 600px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
            .stock-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Card Style */
        .card {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1.1rem;
            color: var(--medium-gray);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-blue);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--medium-blue);
        }

        .input, .select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #BDBDBD;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #FAFAFA;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: var(--dark-blue);
            box-shadow: 0 0 0 3px var(--light-blue);
        }

        /* Button Style */
        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            text-align: center;
        }
        
        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--dark-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--medium-blue);
        }
        
        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--white);
        }
        
        .btn-secondary:hover {
            background-color: #9E9E9E;
        }
        
        /* Stock Management specific styles */
        .stock-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
        }
        
        .stock-actions .input {
            flex-grow: 1;
        }

        .stock-actions .btn {
            width: auto;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            background-color: var(--success); /* Alterado para verde para melhor visibilidade */
            color: var(--white); /* Adicionado para garantir o texto branco */
            font-weight: 700; /* Texto em negrito */
        }
        
        .stock-actions .btn:hover {
             background-color: #2E7D32; /* Verde mais escuro ao passar o mouse */
        }
        
        .last-addition {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
            font-size: 0.9rem;
            color: var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-undo {
            background-color: transparent;
            border: 1px solid var(--medium-gray);
            color: var(--medium-gray);
            padding: 0.25rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-undo:hover {
            background-color: var(--danger);
            color: var(--white);
            border-color: var(--danger);
        }

        /* History List */
        .history-list {
            list-style: none;
            margin-top: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
        }

        .history-list li {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E0E0E0;
        }
        
        .history-list li:last-child {
            border-bottom: none;
        }
        
        .history-list li:nth-child(odd) {
            background-color: #F9F9F9;
        }

        .history-item-details {
            font-size: 0.9rem;
        }

        .history-item-details strong {
            color: var(--dark-blue);
        }

        .history-item-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .history-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .delete-sale-btn {
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            padding: 0.25rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .delete-sale-btn:hover {
            background-color: #FFCDD2; /* Light red */
        }

        /* Sale Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--medium-gray);
            cursor: pointer;
        }
        
        .product-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn-product {
            background-color: var(--white);
            border: 2px solid var(--light-blue);
            border-radius: 8px;
            padding: 1.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .btn-product:hover {
            background-color: var(--light-gray);
            border-color: var(--medium-blue);
        }
        
        .btn-product strong {
            font-size: 1.1rem;
            color: var(--dark-gray);
        }
        
        .btn-product span {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-top: 0.5rem;
        }


        .hidden {
            display: none;
        }

        /* Message/Alert Box */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: var(--white);
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }

        #message-box.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
        
        #message-box.success {
            background-color: var(--success);
        }

        #message-box.error {
            background-color: var(--danger);
        }

    </style>
</head>
<body>
    
    <header>
        <h1>Sistema de Vendas e Estoque</h1>
    </header>

    <div class="container">
        <!-- Profile Section -->
        <section class="profile-section">
            <label for="photo-upload" class="photo-circle" title="Clique para alterar a foto">
                <img id="profile-image" class="hidden" alt="Foto de Perfil">
                <svg id="profile-icon" xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                </svg>
            </label>
            <input type="file" id="photo-upload" class="hidden" accept="image/*">
            <div id="user-name-wrapper">
                 <h2 id="user-name" class="user-name" title="Clique para editar">Seu Nome Aqui</h2>
            </div>
        </section>

        <main>
             <!-- Actions Section -->
            <section id="actions" style="margin-top: 2rem;">
                 <button class="btn btn-primary" id="new-sale-btn" style="padding: 1.25rem; font-size: 1.25rem;">
                    &#43; Nova Venda
                </button>
            </section>

            <!-- Dashboard Section -->
            <section id="dashboard" style="margin-top: 2rem;">
                <h2>Dashboard</h2>
                <div class="grid dashboard-grid">
                    <div class="card">
                        <h3>Total de Pares Vendidos</h3>
                        <p class="value" id="total-pairs-sold">0</p>
                    </div>
                    <div class="card">
                        <h3>Total Faturado</h3>
                        <p class="value" id="total-revenue">R$ 0,00</p>
                    </div>
                     <div class="card">
                        <h3 id="daily-revenue-title">Vendas de Hoje</h3>
                        <p class="value" id="daily-revenue">R$ 0,00</p>
                    </div>
                    <div class="card">
                        <h3>Pares de R$25 Vendidos</h3>
                        <p class="value" id="p25-sold">0</p>
                    </div>
                    <div class="card">
                        <h3>Pares de R$35 Vendidos</h3>
                        <p class="value" id="p35-sold">0</p>
                    </div>
                </div>
            </section>

            <!-- Stock Management Section -->
            <section id="stock" style="margin-top: 2rem;">
                <h2>Gerenciar Estoque</h2>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3>Valor Total em Estoque</h3>
                    <p class="value" id="total-stock-value">R$ 0,00</p>
                </div>
                <div class="grid stock-grid">
                    <div class="card">
                        <h3>Rasteirinha (R$ 25,00)</h3>
                        <p class="value" id="stock-25">0</p>
                        <div class="stock-actions">
                            <input type="number" id="add-stock-25" class="input" placeholder="Qtd." min="1">
                            <button class="btn" onclick="addStock('p25')">Adicionar</button>
                        </div>
                        <div class="last-addition" id="last-addition-p25"></div>
                    </div>
                    <div class="card">
                        <h3>Rasteirinha (R$ 35,00)</h3>
                        <p class="value" id="stock-35">0</p>
                         <div class="stock-actions">
                            <input type="number" id="add-stock-35" class="input" placeholder="Qtd." min="1">
                            <button class="btn" onclick="addStock('p35')">Adicionar</button>
                        </div>
                        <div class="last-addition" id="last-addition-p35"></div>
                    </div>
                </div>
            </section>

            <!-- Sales History Section -->
            <section id="history" style="margin-top: 2rem;">
                <h2>Histórico de Vendas</h2>
                <div class="card">
                    <div class="form-group">
                        <label for="month-filter">Filtrar por Mês</label>
                        <select id="month-filter" class="select"></select>
                    </div>
                    <ul id="sales-history-list" class="history-list">
                       <!-- Sales items will be injected here by JS -->
                    </ul>
                     <p id="no-sales-message" style="text-align: center; color: var(--medium-gray); margin-top: 1.5rem; display: none;">Nenhuma venda registrada para este período.</p>
                </div>
            </section>
        </main>
    </div>
    
    <!-- New Sale Modal -->
    <div id="sale-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" id="close-modal-btn">&times;</button>
            
            <!-- Step 1: Product Selection -->
            <div id="sale-step-1">
                <h2 style="margin-bottom: 0.5rem;">Nova Venda</h2>
                <p style="margin-bottom: 1.5rem; color: var(--medium-gray);">Selecione o produto vendido:</p>
                <div class="product-selection-grid">
                     <button class="btn-product" data-product="p25">
                        <strong>Rasteirinha</strong>
                        <span>R$ 25,00</span>
                     </button>
                     <button class="btn-product" data-product="p35">
                        <strong>Rasteirinha</strong>
                        <span>R$ 35,00</span>
                     </button>
                </div>
            </div>

            <!-- Step 2: Quantity Input -->
            <div id="sale-step-2" class="hidden">
                <h2 id="sale-product-title"></h2>
                <form id="sale-quantity-form">
                    <div class="form-group">
                        <label for="modal-sale-quantity">Quantidade Vendida</label>
                        <input type="number" id="modal-sale-quantity" class="input" placeholder="Qtd." min="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Registrar Venda</button>
                    <button type="button" id="back-to-products-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Voltar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Message/Alert Box -->
    <div id="message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Product Configuration ---
            const products = {
                p25: { name: 'Rasteirinha R$25', price: 25 },
                p35: { name: 'Rasteirinha R$35', price: 35 }
            };

            // --- State Management ---
            let data = {
                profile: { name: 'Seu Nome Aqui', photo: null },
                stock: { p25: 0, p35: 0 },
                salesHistory: [],
                stockHistory: []
            };
            let selectedProductForSale = null;

            // --- DOM Elements ---
            const ui = {
                photoUpload: document.getElementById('photo-upload'),
                profileImage: document.getElementById('profile-image'),
                profileIcon: document.getElementById('profile-icon'),
                userNameWrapper: document.getElementById('user-name-wrapper'),
                userName: document.getElementById('user-name'),
                totalPairsSold: document.getElementById('total-pairs-sold'),
                totalRevenue: document.getElementById('total-revenue'),
                p25Sold: document.getElementById('p25-sold'),
                p35Sold: document.getElementById('p35-sold'),
                stock25: document.getElementById('stock-25'),
                stock35: document.getElementById('stock-35'),
                addStock25Input: document.getElementById('add-stock-25'),
                addStock35Input: document.getElementById('add-stock-35'),
                totalStockValue: document.getElementById('total-stock-value'),
                messageBox: document.getElementById('message-box'),
                monthFilter: document.getElementById('month-filter'),
                salesHistoryList: document.getElementById('sales-history-list'),
                noSalesMessage: document.getElementById('no-sales-message'),
                dailyRevenue: document.getElementById('daily-revenue'),
                dailyRevenueTitle: document.getElementById('daily-revenue-title'),
                lastAdditionP25: document.getElementById('last-addition-p25'),
                lastAdditionP35: document.getElementById('last-addition-p35'),
                
                // New Sale Flow UI
                newSaleBtn: document.getElementById('new-sale-btn'),
                saleModal: document.getElementById('sale-modal'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                saleStep1: document.getElementById('sale-step-1'),
                saleStep2: document.getElementById('sale-step-2'),
                productSelectionButtons: document.querySelectorAll('.btn-product'),
                saleProductTitle: document.getElementById('sale-product-title'),
                saleQuantityForm: document.getElementById('sale-quantity-form'),
                modalSaleQuantityInput: document.getElementById('modal-sale-quantity'),
                backToProductsBtn: document.getElementById('back-to-products-btn')
            };

            // --- Core Functions ---

            function loadData() {
                const savedData = localStorage.getItem('salesStockData');
                if (savedData) {
                    data = JSON.parse(savedData);
                    if (!data.salesHistory) data.salesHistory = [];
                    if (!data.stockHistory) data.stockHistory = [];
                    if (!data.profile) data.profile = { name: 'Seu Nome Aqui', photo: null };
                    if (data.profile.photo === undefined) data.profile.photo = null;
                }
                ui.userName.textContent = data.profile.name;
                updateProfilePhoto();
                populateMonthFilter();
                updateUI();
            }

            function saveData() {
                localStorage.setItem('salesStockData', JSON.stringify(data));
            }

            function updateUI() {
                const selectedMonth = ui.monthFilter.value;
                let filteredSales = data.salesHistory;

                if (selectedMonth !== 'all' && selectedMonth) {
                    filteredSales = data.salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        const saleMonthYear = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                        return saleMonthYear === selectedMonth;
                    });
                }
                
                const stats = filteredSales.reduce((acc, sale) => {
                    acc.totalPairs += sale.quantity;
                    acc.totalRevenue += sale.quantity * sale.price;
                    if (sale.productId === 'p25') acc.p25_sold += sale.quantity;
                    if (sale.productId === 'p35') acc.p35_sold += sale.quantity;
                    return acc;
                }, { totalPairs: 0, totalRevenue: 0, p25_sold: 0, p35_sold: 0 });

                ui.totalPairsSold.textContent = stats.totalPairs;
                ui.totalRevenue.textContent = `R$ ${stats.totalRevenue.toFixed(2).replace('.', ',')}`;
                ui.p25Sold.textContent = stats.p25_sold;
                ui.p35Sold.textContent = stats.p35_sold;

                // --- Daily Sales Calculation (independent of filter) ---
                const today = new Date();
                const todayKey = today.toLocaleDateString('pt-BR'); 
                
                const formattedDate = today.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                ui.dailyRevenueTitle.innerHTML = `Vendas de Hoje <span style="font-weight: 400; color: var(--medium-gray);">(${formattedDate})</span>`;

                const dailyRevenueTotal = data.salesHistory.reduce((acc, sale) => {
                    const saleKey = new Date(sale.date).toLocaleDateString('pt-BR');
                    if (saleKey === todayKey) {
                        return acc + (sale.quantity * sale.price);
                    }
                    return acc;
                }, 0);

                ui.dailyRevenue.textContent = `R$ ${dailyRevenueTotal.toFixed(2).replace('.', ',')}`;


                ui.stock25.textContent = data.stock.p25;
                ui.stock35.textContent = data.stock.p35;
                const totalStockValue = (data.stock.p25 * products.p25.price) + (data.stock.p35 * products.p35.price);
                ui.totalStockValue.textContent = `R$ ${totalStockValue.toFixed(2).replace('.', ',')}`;
                
                renderSalesHistory(filteredSales);
                renderLastAdditions();
            }
            
            function renderLastAdditions() {
                const lastAdditionP25 = [...data.stockHistory].filter(item => item.productId === 'p25').pop();
                const lastAdditionP35 = [...data.stockHistory].filter(item => item.productId === 'p35').pop();
                
                ui.lastAdditionP25.innerHTML = '';
                if(lastAdditionP25) {
                    const date = new Date(lastAdditionP25.date);
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    ui.lastAdditionP25.innerHTML = `
                        <span>Última adição: <strong>+${lastAdditionP25.quantity}</strong> em ${formattedDate}</span>
                        <button class="btn-undo" onclick="undoLastStockAddition('p25')">Desfazer</button>
                    `;
                }
                
                ui.lastAdditionP35.innerHTML = '';
                 if(lastAdditionP35) {
                    const date = new Date(lastAdditionP35.date);
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    ui.lastAdditionP35.innerHTML = `
                       <span>Última adição: <strong>+${lastAdditionP35.quantity}</strong> em ${formattedDate}</span>
                       <button class="btn-undo" onclick="undoLastStockAddition('p35')">Desfazer</button>
                    `;
                }
            }
            
            function populateMonthFilter() {
                const months = new Set();
                data.salesHistory.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    const monthYear = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthYear);
                });

                const currentFilterValue = ui.monthFilter.value;
                ui.monthFilter.innerHTML = '<option value="all">Todos os Meses</option>';
                const sortedMonths = Array.from(months).sort().reverse();
                
                sortedMonths.forEach(month => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleString('pt-BR', { month: 'long' });
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)}/${year}`;
                    ui.monthFilter.appendChild(option);
                });
                ui.monthFilter.value = currentFilterValue || 'all';
            }

            function renderSalesHistory(sales) {
                ui.salesHistoryList.innerHTML = '';
                if (sales.length === 0) {
                    ui.noSalesMessage.style.display = 'block';
                    ui.salesHistoryList.style.display = 'none';
                    return;
                }
                
                ui.noSalesMessage.style.display = 'none';
                ui.salesHistoryList.style.display = 'block';

                sales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                    const li = document.createElement('li');
                    const saleDate = new Date(sale.date);
                    const formattedDate = saleDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const totalValue = (sale.quantity * sale.price).toFixed(2).replace('.', ',');

                    li.innerHTML = `
                        <div class="history-item-details">
                            <strong>${products[sale.productId].name}</strong>
                            <div style="color: var(--medium-gray);">${sale.quantity} unid. &bull; ${formattedDate}</div>
                        </div>
                        <div class="history-item-actions">
                            <span class="history-item-value">R$ ${totalValue}</span>
                            <button class="delete-sale-btn" data-sale-id="${sale.date}" title="Excluir Venda">&times;</button>
                        </div>
                    `;
                    ui.salesHistoryList.appendChild(li);
                });
            }

            function showMessage(message, type = 'success') {
                ui.messageBox.textContent = message;
                ui.messageBox.className = type;
                ui.messageBox.classList.add('show');
                
                setTimeout(() => {
                    ui.messageBox.classList.remove('show');
                }, 3000);
            }

            function deleteSale(saleId) {
                const saleIndex = data.salesHistory.findIndex(sale => sale.date === saleId);

                if (saleIndex === -1) {
                    showMessage('Erro: Venda não encontrada.', 'error');
                    return;
                }

                const saleToDelete = data.salesHistory[saleIndex];
                
                // Restore stock
                data.stock[saleToDelete.productId] += saleToDelete.quantity;

                // Remove sale from history
                data.salesHistory.splice(saleIndex, 1);

                saveData();
                populateMonthFilter(); // Update the filter in case the last sale of a month was deleted
                updateUI();

                showMessage('Venda excluída e estoque restaurado.', 'success');
            }
            
            function updateProfilePhoto() {
                if (data.profile.photo) {
                    ui.profileImage.src = data.profile.photo;
                    ui.profileImage.classList.remove('hidden');
                    ui.profileIcon.classList.add('hidden');
                } else {
                    ui.profileImage.classList.add('hidden');
                    ui.profileIcon.classList.remove('hidden');
                }
            }

            // --- Profile Editing Logic ---
            function setupProfileEditing() {
                ui.userName.addEventListener('click', () => {
                    const currentName = ui.userName.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'user-name-input';
                    input.value = currentName;

                    const saveName = () => {
                        const newName = input.value.trim();
                        if (newName && newName !== data.profile.name) {
                            data.profile.name = newName;
                            saveData();
                        }
                        ui.userName.textContent = data.profile.name;
                        ui.userNameWrapper.replaceChild(ui.userName, input);
                    };

                    input.addEventListener('blur', saveName);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            input.blur();
                        } else if (e.key === 'Escape') {
                            input.value = data.profile.name;
                            input.blur();
                        }
                    });

                    ui.userNameWrapper.replaceChild(input, ui.userName);
                    input.focus();
                    input.select();
                });
            }
            
            function setupPhotoUpload() {
                ui.photoUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = () => {
                        data.profile.photo = reader.result;
                        saveData();
                        updateProfilePhoto();
                        showMessage('Foto de perfil atualizada!', 'success');
                    };
                    reader.readAsDataURL(file);
                });
            }


            // --- New Sale Modal Logic ---
            function openSaleModal() {
                ui.saleStep1.classList.remove('hidden');
                ui.saleStep2.classList.add('hidden');
                ui.saleModal.classList.add('show');
            }

            function closeSaleModal() {
                ui.saleModal.classList.remove('show');
                ui.saleQuantityForm.reset();
                selectedProductForSale = null;
            }

            // --- Event Handlers ---
            ui.newSaleBtn.addEventListener('click', openSaleModal);
            ui.closeModalBtn.addEventListener('click', closeSaleModal);
            ui.saleModal.addEventListener('click', (e) => {
                if (e.target === ui.saleModal) {
                    closeSaleModal();
                }
            });

            ui.salesHistoryList.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-sale-btn');
                if (deleteButton) {
                    const saleId = deleteButton.dataset.saleId;
                    deleteSale(saleId);
                }
            });

            ui.productSelectionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedProductForSale = btn.dataset.product;
                    ui.saleProductTitle.textContent = `Venda de ${products[selectedProductForSale].name}`;
                    ui.saleStep1.classList.add('hidden');
                    ui.saleStep2.classList.remove('hidden');
                    ui.modalSaleQuantityInput.focus();
                });
            });

            ui.backToProductsBtn.addEventListener('click', () => {
                ui.saleStep2.classList.add('hidden');
                ui.saleStep1.classList.remove('hidden');
                ui.saleQuantityForm.reset();
                selectedProductForSale = null;
            });



            ui.saleQuantityForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const productId = selectedProductForSale;
                const quantity = parseInt(ui.modalSaleQuantityInput.value, 10);
                
                if (!productId) { return; } // Should not happen
                if (isNaN(quantity) || quantity <= 0) { showMessage('Por favor, insira uma quantidade válida.', 'error'); return; }
                if (quantity > data.stock[productId]) { showMessage('Venda não realizada. Estoque insuficiente!', 'error'); return; }
                
                const product = products[productId];
                data.stock[productId] -= quantity;

                const saleRecord = { productId, quantity, price: product.price, date: new Date().toISOString() };
                data.salesHistory.push(saleRecord);
                
                populateMonthFilter();
                saveData();
                updateUI();
                
                showMessage(`Venda de ${quantity} ${product.name}(s) registrada!`, 'success');
                closeSaleModal();
            });
            
            ui.monthFilter.addEventListener('change', updateUI);

            window.addStock = (productId) => {
                const inputElement = (productId === 'p25') ? ui.addStock25Input : ui.addStock35Input;
                const quantity = parseInt(inputElement.value, 10);

                if (isNaN(quantity) || quantity <= 0) {
                    showMessage('Por favor, insira uma quantidade válida para adicionar.', 'error');
                    return;
                }
                data.stock[productId] += quantity;
                
                data.stockHistory.push({
                    productId: productId,
                    quantity: quantity,
                    date: new Date().toISOString()
                });
                
                saveData();
                updateUI();
                showMessage(`${quantity} unidade(s) adicionada(s) ao estoque.`, 'success');
                inputElement.value = '';
            }
            
            window.undoLastStockAddition = (productId) => {
                const stockAdditionsForProduct = data.stockHistory.filter(item => item.productId === productId);
                if (stockAdditionsForProduct.length === 0) {
                    showMessage('Nenhuma adição para desfazer.', 'error');
                    return;
                }

                const lastAddition = stockAdditionsForProduct[stockAdditionsForProduct.length - 1];
                
                if (data.stock[productId] < lastAddition.quantity) {
                     showMessage('Não é possível desfazer. Itens desta adição já foram vendidos.', 'error');
                     return;
                }
                
                // Find the index of the absolute last item in the main history array to remove it
                const itemIndex = data.stockHistory.findLastIndex(item => 
                    item.date === lastAddition.date && item.productId === lastAddition.productId
                );

                if (itemIndex > -1) {
                    data.stock[productId] -= lastAddition.quantity;
                    data.stockHistory.splice(itemIndex, 1);
                    saveData();
                    updateUI();
                    showMessage('Última adição desfeita com sucesso!', 'success');
                }
            }

            // --- Initialization ---
            loadData();
            setupProfileEditing();
            setupPhotoUpload();
        });
    </script>
</body>
</html>


